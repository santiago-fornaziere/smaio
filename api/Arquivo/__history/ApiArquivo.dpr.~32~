program ApiArquivo;
{$APPTYPE CONSOLE}
{$R *.res}
uses
  Vcl.Forms,
  Uni,
  Horse,
  Horse.OctetStream,
  System.Classes,
  System.SysUtils,
  Horse.JWT,
  Horse.Cors,
  UntDmConexao in '..\Tools\UntDmConexao.pas' {DmConexao: TDataModule},
  UntModel.Claims in '..\Models\UntModel.Claims.pas',
  UntFuncoes in '..\Tools\UntFuncoes.pas';

begin
  Application.CreateForm(TDmConexao, DmConexao);
  THorse.Use(OctetStream);
  THorse.Use(Cors);

  THorse.Get('/arquivos',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LStream: TFileStream;
    begin
      LStream := TFileStream.Create('c:\temp\demo.txt', fmOpenRead);
      Res.Send<TStream>(LStream);
    end);

  THorse.Post('/bfcall/chamadoanexo/:nome/:chamado', HorseJWT('key', TClaims),
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LStream: TMemoryStream;
      vNome: String;
      vChamado : integer;
      LClaims: TClaims;
      vQry : TUniQuery;
      vSQL, fLinha : String;
      f : TextFile;
    begin
      try
        if not Assigned(LClaims) then
          LClaims := Req.Session<TClaims>;
        vNome := Req.Params.Items['nome'];
        vChamado := Req.Params.Items['chamado'].ToInteger;
        LStream:= Req.Body<TMemoryStream>;
        LStream.SaveToFile('c:\temp\'+FloatToStr(now())+vNome);

        AssignFile(f, Sistema.Path_SQL+'BfCall\chamado_anexo\chamado_anexo_insert.sql');
        Reset(f);
        vSQL := '';
        While not Eof(f) do
        begin
          Readln(f, fLinha);
          vSQL := vSQL + fLinha;
        end;
        CloseFile(f);
        vQry := TUniQuery.Create(nil);
        vQry.Close;
        vQry.Connection := DmConexao.DbConexao;
        vQry.SQL.Add(StringReplace(vSQL, 'ï»¿﻿','',[]));
        vQry.Params[0].AsString  := 'c:\temp\'+FloatToStr(now())+vNome;
        vQry.Params[1].AsString := LClaims.UsuarioID;
        vQry.Params[2].AsInteger := vChamado;
        vQry.Execute;

        Res.Send('Imagem cadastrada com sucesso...').Status(201);
      finally
//        Freeandnil(LClaims);
//        FreeAndNil(vQry);
      end;
    end);

  THorse.Listen(9098);
end.
