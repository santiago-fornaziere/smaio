unit UntController.BFCall.ChamadoAnexo;

interface

uses
  System.SysUtils,
  Vcl.Dialogs,
  UntFuncoes,
  System.Generics.Collections,
  System.JSON,
  DataSet.Serialize,
  System.Classes,
  Horse,
  UntModel.Claims,
  UntController.Authorization,
  UntModel.Query;

  procedure registrar;

implementation

function SelectByID(pID: integer): TJSONArray;
var
   vSQL, fLinha : String;
   vQry : TQuery;
   f : TextFile;
begin
  try
    AssignFile(f, Sistema.Path_SQL+'BfCall\Chamado_anexo\chamado_anexo_by_ID.sql');
    Reset(f);
    vSQL := '';
    While not Eof(f) do
    begin
      Readln(f, fLinha);
      vSQL := vSQL + fLinha;
    end;
    CloseFile(f);
    vQry := TQuery.Create;
    vQry.Query.SQL.Add(StringReplace(vSQL, 'ï»¿﻿','',[]));
    vQry.Query.Params[0].AsInteger := pID;
    vQry.Query.Open;
    Result := vQry.Query.ToJSONArray;
  finally
    FreeAndNil(vQry);
  end;
end;


procedure GetByChamID(Req: THorseRequest; Res: THorseResponse; Next: TProc);
begin
  Res.Send<TJSONAncestor>(SelectByID(Req.Params.Items['id'].ToInteger));
end;

procedure Insert(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  LStream: TMemoryStream;
  vNome: String;
  vChamado, vUsuario : integer;
  LClaims: TClaims;
  vQry : TQuery;
  vSQL, fLinha : String;
  f : TextFile;
begin
  try
    LClaims := Req.Session<TClaims>;
    vNome := Sistema.Path_Anexo+StringReplace(FloatToStr(now()), ',','', [])+Req.Params.Items['nome'];
    vChamado := Req.Params.Items['chamado'].ToInteger;
    LStream:= Req.Body<TMemoryStream>;
    LStream.SaveToFile(vNome);

    AssignFile(f, Sistema.Path_SQL+'BfCall\chamado_anexo\chamado_anexo_insert.sql');
    Reset(f);
    vSQL := '';
    While not Eof(f) do
    begin
      Readln(f, fLinha);
      vSQL := vSQL + fLinha;
    end;
    CloseFile(f);
    vQry := TQuery.Create;
    vQry.Query.SQL.Add(StringReplace(vSQL, 'ï»¿﻿','',[]));
    vQry.Query.Params[0].AsString  := vNome;
    vQry.Query.Params[1].AsString := LClaims.UsuarioID;
    vQry.Query.Params[2].AsInteger := vChamado;
    vQry.Query.Execute;

    Res.Send('Imagem cadastrada com sucesso...').Status(201);
  finally
    FreeAndNil(vQry);
  end;
end;

procedure GetArquivo(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  LStream: TFileStream;
  vFile : String;
begin
     try
       vFile :='http://www.gerencialsistemas.com.br/imagens/logo.png'; // parte a ser implementada após a definição do caminho da aplicação na web
       LStream := TFileStream.Create(vFile, fmOpenRead);
       Res.Send<TStream>(LStream).Status(200);
     finally
       Freeandnil(LStream);
     end;
end;

procedure registrar;
begin
  THorse.Get( '/bfcall/chamadoanexo/:id', Authorization(), GetByChamID);
  THorse.Get( '/bfcall/chamadoanexo/', GetArquivo);
  THorse.Post('/bfcall/chamadoanexo/:nome/:chamado', HorseJWT('key', TClaims), Insert);
end;


end.
